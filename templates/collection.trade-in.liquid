{% comment %}
  Trade-In Collection Template
  This template displays all products in the current collection with trade‑in details.
  Trade-in Cash Price = 65% of listed price (rounded down to the nearest pound)
  Trade-in Store Credit Price = 85% of listed price (rounded down to the nearest pound)
  Assumes product.price is in pence.
{% endcomment %}

{% layout 'theme' %}

<div class="trade-in-collection-page">
  <h1>{{ collection.title }} - Trade-In Items</h1>
  <p>Select the cards you wish to trade in and specify the quantity for each.</p>

  {% if collection.products.size > 0 %}
    <div class="trade-in-table-container">
      <div class="trade-in-table-header">
        <div class="header-cell card-col">Card</div>
        <div class="header-cell">Cash Price</div>
        <div class="header-cell">Store Credit Price</div>
        <div class="header-cell">Quantity</div>
        <div class="header-cell">Action</div>
      </div>
      <div class="trade-in-table-body">
        {% for product in collection.products %}
          {% assign variant = product.selected_or_first_available_variant %}
          {% assign listed_pounds = product.price | divided_by: 100.0 %}
          {% assign cash_price = listed_pounds | times: 0.65 | floor %}
          {% assign credit_price = listed_pounds | times: 0.85 | floor %}
          {% assign available_stock = variant.inventory_quantity | default: 0 %}
          {% assign max_trade_in = 8 | minus: available_stock %}
          <div class="trade-in-row">
            <div class="trade-in-cell card-col">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title }}">
              {% endif %}
              <p>{{ product.title }}</p>
            </div>
            <div class="trade-in-cell">£{{ cash_price }}</div>
            <div class="trade-in-cell">£{{ credit_price }}</div>
            <div class="trade-in-cell">
              {% form 'product', product, class: 'trade-in-form' %}
                {%- if max_trade_in > 0 -%}
                  <input type="number" name="quantity" value="1" min="1" max="{{ max_trade_in }}" style="width: 60px;">
                  <br>
                  <small>Max: {{ max_trade_in }}</small>
                {%- else -%}
                  <p>Trade-in unavailable</p>
                {%- endif -%}
              {% endform %}
            </div>
            <div class="trade-in-cell trade-in-actions">
              {% form 'product', product, class: 'trade-in-form' %}
                <input type="hidden" name="id" value="{{ variant.id }}">
                <input type="hidden" name="properties[Trade In]" value="Yes">
                <input type="hidden" name="properties[Trade In Type]" value="Cash" class="trade-in-type">
                {%- if max_trade_in > 0 -%}
                  <div class="trade-in-buttons">
                    <button type="button" class="btn btn--secondary trade-in-btn cash-btn" 
                            data-type="Cash" 
                            data-unit-price="{{ cash_price }}"
                            data-product-title="{{ product.title }}">
                      <span class="btn-label">Cash</span>
                      <span class="btn-price">£{{ cash_price }}</span>
                    </button>
                    <button type="button" class="btn btn--secondary trade-in-btn credit-btn" 
                            data-type="Store Credit" 
                            data-unit-price="{{ credit_price }}"
                            data-product-title="{{ product.title }}">
                      <span class="btn-label">Store Credit</span>
                      <span class="btn-price">£{{ credit_price }}</span>
                    </button>
                  </div>
                {%- else -%}
                  <button type="button" class="btn btn--secondary" disabled>Unavailable</button>
                {%- endif -%}
              {% endform %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <p>No trade‑in items available in this collection.</p>
  {% endif %}
</div>

<script>
  // Handle trade-in buttons and form submissions with dynamic pricing
  document.addEventListener('DOMContentLoaded', function() {
    // Find all trade-in buttons and quantity inputs
    const tradeInButtons = document.querySelectorAll('.trade-in-btn');
    const quantityInputs = document.querySelectorAll('input[name="quantity"]');
    
    // Function to update button prices based on quantity
    function updateButtonPrices(row) {
      const quantityInput = row.querySelector('input[name="quantity"]');
      const quantity = parseInt(quantityInput.value) || 1;
      
      // Update all buttons in this row
      const buttons = row.querySelectorAll('.trade-in-btn');
      buttons.forEach(button => {
        const unitPrice = parseFloat(button.getAttribute('data-unit-price'));
        const totalPrice = (unitPrice * quantity).toFixed(2);
        
        // Update button price display
        const priceElement = button.querySelector('.btn-price');
        priceElement.textContent = `£${totalPrice}`;
      });
    }
    
    // Add input handler to all quantity inputs
    quantityInputs.forEach(input => {
      input.addEventListener('input', function() {
        const row = this.closest('.trade-in-row');
        updateButtonPrices(row);
      });
      
      // Initialize prices
      const row = input.closest('.trade-in-row');
      updateButtonPrices(row);
    });
    
    // Add click handler to each button
    tradeInButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        // Get the parent form and row
        const form = button.closest('.trade-in-form');
        const row = button.closest('.trade-in-row');
        
        // Get the trade-in type input field within the form
        const tradeInTypeInput = form.querySelector('.trade-in-type');
        
        // Set the trade-in type based on the button clicked
        const tradeInType = button.getAttribute('data-type');
        tradeInTypeInput.value = tradeInType;
        
        // Find the quantity input (from the other form in the same row)
        const quantityInput = row.querySelector('input[name="quantity"]');
        const quantity = parseInt(quantityInput.value) || 1;
        
        // Validate quantity
        if (!quantity || quantity <= 0) {
          alert('Please enter a quantity greater than 0.');
          return;
        }
        
        // Get variant ID and product title
        const variantId = form.querySelector('input[name="id"]').value;
        const productTitle = button.getAttribute('data-product-title');
        
        // Calculate total price
        const unitPrice = parseFloat(button.getAttribute('data-unit-price'));
        const totalPrice = (unitPrice * quantity).toFixed(2);
        
        // Create the payload with all necessary properties
        const payload = {
          items: [{
            id: variantId,
            quantity: quantity,
            properties: {
              "Trade In": "Yes",
              "Trade In Type": tradeInType,
              "Unit Price": `£${unitPrice}`,
              "Total Value": `£${totalPrice}`
            }
          }]
        };
        
        // Add active state to the clicked button and remove from other button
        button.closest('.trade-in-buttons').querySelectorAll('.trade-in-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        button.classList.add('active');
        
        // Send the AJAX request
        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(`Added ${quantity} of "${productTitle}" to your cart as a "${tradeInType}" trade-in.\nTotal value: £${totalPrice}`);
          // Reset only the quantity field but maintain the active state of the button
          quantityInput.value = 1;
          // Update button prices after resetting quantity
          updateButtonPrices(row);
        })
        .catch(error => {
          console.error('Error adding to cart:', error);
          alert('There was an error adding the item to your cart.');
        });
      });
    });
  });
</script>

<style>
  /* Full-width responsive layout */
  .trade-in-collection-page {
    width: 100%;
    max-width: 100%;
    padding: 20px;
    box-sizing: border-box;
  }
  
  /* Sticky header and flex layout */
  .trade-in-table-container {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    position: relative;
    left: 0;
    right: 0;
  }
  
  .trade-in-table-header {
    display: flex;
    background-color: #f8f8f8;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 100%;
  }
  
  .header-cell {
    flex: 1;
    padding: 15px 10px;
    text-align: center;
    border-bottom: 1px solid #ddd;
  }
  
  .trade-in-row {
    display: flex;
    border-bottom: 1px solid #ddd;
    width: 100%;
  }
  
  .trade-in-row:last-child {
    border-bottom: none;
  }
  
  .trade-in-cell {
    flex: 1;
    padding: 15px 10px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  
  .card-col {
    flex: 1.5;
  }
  
  .trade-in-cell img {
    max-width: 100px;
    max-height: 100px;
    display: block;
    margin: 0 auto 10px;
    object-fit: contain;
  }
  
  /* Alternating row colors for better readability */
  .trade-in-row:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    .trade-in-table-header {
      display: none; /* Hide header on mobile for more space */
    }
    
    .trade-in-row {
      flex-direction: column;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .trade-in-cell {
      width: 100%;
      padding: 15px;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    
    .trade-in-cell:before {
      content: attr(data-label);
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.85em;
      display: block;
      margin-bottom: 8px;
    }
    
    .card-col {
      order: -1; /* Card always at the top on mobile */
      background-color: #f8f8f8;
    }
    
    .trade-in-cell img {
      max-width: 150px;
      max-height: 150px;
    }
  }
  
  /* Trade-in action buttons */
  .trade-in-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }
  
  .trade-in-btn {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px !important;
    border-radius: 4px;
    transition: all 0.2s ease;
    width: 100%;
  }
  
  .cash-btn {
    background-color: #f8f8f8;
    border: 1px solid #ddd;
    color: #333;
  }
  
  .credit-btn {
    background-color: #f0f7ff;
    border: 1px solid #b8daff;
    color: #0056b3;
  }
  
  .trade-in-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .trade-in-btn.active {
    box-shadow: 0 0 0 2px #4a90e2;
  }
  
  .cash-btn.active {
    background-color: #e9e9e9;
  }
  
  .credit-btn.active {
    background-color: #e6f2ff;
  }
  
  .btn-label {
    font-weight: bold;
  }
  
  .btn-price {
    font-size: 0.9em;
    background: rgba(0,0,0,0.05);
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  /* Make buttons full width on mobile */
  @media (max-width: 768px) {
    .trade-in-form input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .trade-in-actions {
      padding: 15px;
    }
  }
</style>

<!-- Add data-label attributes to cells with JavaScript for mobile responsiveness -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add data attributes for mobile responsive labels
    const cells = document.querySelectorAll('.trade-in-cell');
    const headers = ['Card', 'Cash Price', 'Store Credit Price', 'Quantity', 'Action'];
    
    cells.forEach(function(cell, index) {
      const headerIndex = index % 5; // 5 columns in our table
      cell.setAttribute('data-label', headers[headerIndex]);
    });
  });
</script>