{% layout theme %}

<div id="admin_header">
  <div class="action_link action_return note" id="return_to_store">
    <a href="{{ shop.url }}">{{ 'general.account.return_to_store' | t }}</a>
  </div>
  <h2 class="title">{{ 'customer.account.title' | t }}</h2>
</div>

<div id="customer_sidebar">
  <div id="customer_detail" class="group">
    <h5 class="name">{{ customer.name }}</h5>
    <p class="email note">{{ customer.email }}</p>

    {% if customer.phone %}
      <p class="phone note">{{ 'customer.phone.label' | t }}: {{ customer.phone }}</p>
    {% endif %}

    {% if customer.gift_cards.size > 0 %}
      <p class="store-credit note">
        {{ 'account.store_credit.label' | t }}: {{ customer.gift_cards.first.balance | money }}
      </p>
    {% elsif customer.metafields.account.store_credit %}
      <p class="store-credit note">
        {{ 'account.store_credit.label' | t }}: {{ customer.metafields.account.store_credit | money }}
      </p>
    {% endif %}

    <div class="address note">
      {% if customer.default_address %}
        <p>{{ customer.default_address.address1 }}</p>
        {% if customer.default_address.address2 != blank %}
          <p>{{ customer.default_address.address2 }}</p>
        {% endif %}
        <p>
          {{ customer.default_address.city }},
          {% if customer.default_address.province_code %}
            {{ customer.default_address.province_code }},
          {% endif %}
          {{ customer.default_address.country }}
        </p>
        <p>{{ customer.default_address.zip }}</p>
      {% endif %}
    </div>

    <a id="view_address" href="{{ routes.account_addresses_url }}" class="btn btn--underline">
      {{ 'customer.addresses.view' | t: count: customer.addresses_count }}
    </a>
    <a id="customer_raffles_link" href="/pages/my-raffles" class="btn btn--underline">
      {{ 'account.raffles.nav' | t }}
    </a>
    <a id="customer_trade_in_link" href="/pages/trade-in" class="btn btn--underline">
      {{ 'account.trade_ins.nav' | t | default: 'Trade-In Cards' }}
    </a>
  </div>
</div>

<div id="customer_orders">
  {% if customer.orders.size > 0 %}
    <table>
      <thead>
        <tr>
          <th>{{ 'customer.order.number' | t }}</th>
          <th>{{ 'customer.order.date' | t }}</th>
          <th>{{ 'customer.order.payment_status' | t }}</th>
          <th>{{ 'customer.order.fulfillment_status' | t }}</th>
          <th>{{ 'customer.order.total' | t }}</th>
        </tr>
      </thead>
      <tbody>
        {% for order in customer.orders %}
          <tr class="{% cycle 'odd', 'even' %}{% if order.cancelled %} cancelled_order{% endif %}">
            <td>{{ order.name | link_to: order.customer_url }}</td>
            <td>
              <span class="note">{{ order.created_at | date: '%b %d, %Y' }}</span>
            </td>
            <td>
              <span class="status_{{ order.financial_status }}">{{ order.financial_status }}</span>
            </td>
            <td>
              <span class="status_{{ order.fulfillment_status }}">{{ order.fulfillment_status }}</span>
            </td>
            <td>
              <span class="total money">{{ order.total_price | money }}</span>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>{{ 'customer.orders.empty' | t }}</p>
  {% endif %}
</div>

<!-- Trade-In History Module -->
<div id="customer_trade_ins" class="section section--padding">
  <div class="section__wrapper">
    <div class="trade-in-header">
      <h3>{{ 'account.trade_ins.title' | t | default: 'Trade-In Submissions' }}</h3>
      <a href="/pages/trade-in" class="btn btn--small">{{ 'account.trade_ins.new' | t | default: 'Start New Trade-In' }}</a>
    </div>

    <div id="tradeInList" class="trade-in-list">
      <p class="loading-message">Loading your trade-in submissions...</p>
    </div>

    <template id="tradeInItemTemplate">
      <div class="trade-in-item card p-4">
        <div class="trade-in-item__header">
          <span class="trade-in-item__number"></span>
          <span class="trade-in-item__status"></span>
        </div>
        <div class="trade-in-item__details">
          <span class="trade-in-item__date"></span>
          <span class="trade-in-item__value"></span>
          <span class="trade-in-item__items"></span>
        </div>
        <a href="#" class="trade-in-item__track btn btn--small btn--outline">Track</a>
      </div>
    </template>
  </div>
</div>

<script>
  (function() {
    const listEl = document.getElementById('tradeInList');
    const template = document.getElementById('tradeInItemTemplate');

    async function loadTradeIns() {
      try {
        const response = await fetch('/apps/trade-in/submissions?limit=5');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to load submissions');
        }

        if (!data.submissions || data.submissions.length === 0) {
          listEl.innerHTML = '<p class="empty-message note">{{ "account.trade_ins.empty" | t | default: "You haven\'t submitted any trade-ins yet." }}</p>';
          return;
        }

        listEl.innerHTML = '';
        data.submissions.forEach(sub => {
          const item = template.content.cloneNode(true);
          item.querySelector('.trade-in-item__number').textContent = sub.submissionNumber;
          item.querySelector('.trade-in-item__status').textContent = formatStatus(sub.status);
          item.querySelector('.trade-in-item__status').dataset.status = sub.status;
          item.querySelector('.trade-in-item__date').textContent = formatDate(sub.createdAt);
          item.querySelector('.trade-in-item__value').textContent = formatPrice(sub.quotedTotal);
          item.querySelector('.trade-in-item__items').textContent = sub.itemCount + ' items';
          item.querySelector('.trade-in-item__track').href = '/pages/trade-in-track?number=' + encodeURIComponent(sub.submissionNumber);
          listEl.appendChild(item);
        });

      } catch (err) {
        console.error('Trade-in load error:', err);
        listEl.innerHTML = '<p class="error-message note">Unable to load trade-in submissions. <a href="/pages/trade-in-track">Track manually</a></p>';
      }
    }

    function formatStatus(status) {
      const labels = {
        'DRAFT': 'Draft',
        'SUBMITTED': 'Submitted',
        'IN_TRANSIT': 'In Transit',
        'RECEIVED': 'Received',
        'GRADING': 'Grading',
        'PENDING_APPROVAL': 'Pending Approval',
        'APPROVED': 'Approved',
        'COMPLETED': 'Completed',
        'CANCELLED': 'Cancelled',
        'RETURNED': 'Returned'
      };
      return labels[status] || status;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function formatPrice(pence) {
      return 'Â£' + (pence / 100).toFixed(2);
    }

    loadTradeIns();
  })();
</script>

<style>
  #customer_trade_ins {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgb(var(--color-border));
  }

  .trade-in-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .trade-in-header h3 {
    margin: 0;
    font-size: 1.25rem;
  }

  .trade-in-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .trade-in-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgb(var(--color-secondary-background));
    border-radius: 0.5rem;
  }

  .trade-in-item__header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 200px;
  }

  .trade-in-item__number {
    font-family: monospace;
    font-weight: 600;
  }

  .trade-in-item__status {
    display: inline-flex;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    background: #3b82f6;
    color: white;
  }

  .trade-in-item__status[data-status="SUBMITTED"],
  .trade-in-item__status[data-status="IN_TRANSIT"] {
    background: #f59e0b;
  }

  .trade-in-item__status[data-status="COMPLETED"],
  .trade-in-item__status[data-status="APPROVED"] {
    background: #10b981;
  }

  .trade-in-item__status[data-status="CANCELLED"],
  .trade-in-item__status[data-status="RETURNED"] {
    background: #ef4444;
  }

  .trade-in-item__details {
    display: flex;
    gap: 1rem;
    color: rgb(var(--color-foreground) / 0.7);
    font-size: 0.875rem;
  }

  .trade-in-item__track {
    margin-left: auto;
  }

  .loading-message,
  .empty-message,
  .error-message {
    text-align: center;
    padding: 1rem;
    color: rgb(var(--color-foreground) / 0.6);
  }

  @media (max-width: 640px) {
    .trade-in-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .trade-in-item__track {
      margin-left: 0;
      width: 100%;
      text-align: center;
    }
  }
</style>

<!-- Raffles Preview Module -->
<div id="customer_raffles_preview" class="section section--padding">
  <div class="section__wrapper">
    <div class="raffle-header">
      <h3>{{ 'account.raffles.title' | t }}</h3>
      <a href="/pages/my-raffles" class="btn btn--small">{{ 'general.button.view_all' | t }}</a>
    </div>

    {% assign prizes = customer.metafields.raffles.prizes %}
    {% if prizes and prizes.size > 0 %}
      <ul class="raffles-list grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for product in prizes limit: 2 %}
          <li class="card p-4">
            <a href="{{ product.url }}" class="flex items-center space-x-4">
              {% if product.featured_image %}
                <img
                  src="{{ product.featured_image | img_url: "200x" }}"
                  alt="{{ product.title }}"
                  class="w-16 h-16 object-cover rounded"
                >
              {% endif %}
              <div>
                <h4 class="font-semibold">{{ product.title }}</h4>
                {% if product.price %}
                  <p class="text-sm">{{ product.price | money }}</p>
                {% endif %}
              </div>
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-center note">{{ 'account.raffles.empty' | t }}</p>
    {% endif %}
  </div>
</div>
