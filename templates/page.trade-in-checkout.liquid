{% comment %}
  Trade-In Checkout Page
  Final step in the trade-in process
{% endcomment %}

{% layout 'theme' %}

<div class="trade-in-checkout-page">
  <h1>Complete Your Trade-In</h1>
  
  <div class="checkout-container">
    <div class="trade-in-summary-section">
      <h2>Trade-In Summary</h2>
      
      {% assign has_trade_in_items = false %}
      {% assign trade_in_total = 0 %}
      
      <div class="trade-in-items-summary">
        {% for item in cart.items %}
          {% if item.properties['Trade In'] == 'Yes' %}
            {% assign has_trade_in_items = true %}
            {% assign total_price = item.properties['Total Value'] | remove: '£' | times: 1 %}
            {% assign trade_in_total = trade_in_total | plus: total_price %}
            
            <div class="summary-item">
              <div class="summary-item-image">
                <img src="{{ item.image | img_url: 'small' }}" alt="{{ item.title }}">
              </div>
              <div class="summary-item-details">
                <p class="summary-item-title">{{ item.product.title }}</p>
                <p class="summary-item-meta">
                  <span>{{ item.quantity }} × {{ item.properties['Unit Price'] }}</span>
                  <span>({{ item.properties['Trade In Type'] }})</span>
                </p>
              </div>
              <div class="summary-item-value">
                {{ item.properties['Total Value'] }}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <div class="trade-in-total-section">
        <div class="trade-in-total-row">
          <span>Total Trade-In Value:</span>
          <span class="total-value">£{{ trade_in_total | round: 2 }}</span>
        </div>
      </div>
    </div>
    
    <div class="trade-in-shipping-section">
      <h2>Shipping Details</h2>
      <p>Please provide your shipping details for sending in your trade-in items.</p>
      
      <form id="trade-in-form" class="trade-in-form">
        <div class="form-group">
          <label for="full-name">Full Name</label>
          <input type="text" id="full-name" name="full_name" required>
        </div>
        
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone">
        </div>
        
        <div class="form-group">
          <label for="address">Address</label>
          <textarea id="address" name="address" rows="3" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" name="city" required>
        </div>
        
        <div class="form-group">
          <label for="postal-code">Postal Code</label>
          <input type="text" id="postal-code" name="postal_code" required>
        </div>
        
        <div class="form-group">
          <label for="country">Country</label>
          <input type="text" id="country" name="country" required>
        </div>
        
        <div class="form-group payment-method">
          <label>Preferred Payment Method</label>
          <div class="radio-group">
            <input type="radio" id="payment-cash" name="payment_method" value="bank_transfer" required>
            <label for="payment-cash">Bank Transfer (Cash Trade-In)</label>
          </div>
          <div class="radio-group">
            <input type="radio" id="payment-credit" name="payment_method" value="store_credit">
            <label for="payment-credit">Store Credit</label>
          </div>
        </div>
        
        <div class="form-group bank-details" id="bank-details-section" style="display: none;">
          <h3>Bank Details (for Cash Trade-In)</h3>
          
          <div class="form-group">
            <label for="account-name">Account Holder Name</label>
            <input type="text" id="account-name" name="account_name" class="bank-field">
          </div>
          
          <div class="form-group">
            <label for="account-number">Account Number</label>
            <input type="text" id="account-number" name="account_number" class="bank-field">
          </div>
          
          <div class="form-group">
            <label for="sort-code">Sort Code</label>
            <input type="text" id="sort-code" name="sort_code" class="bank-field">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn">Complete Trade-In</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const paymentMethod = document.querySelectorAll('input[name="payment_method"]');
    const bankDetailsSection = document.getElementById('bank-details-section');
    const bankFields = document.querySelectorAll('.bank-field');
    
    // Show/hide bank details based on payment method
    paymentMethod.forEach(input => {
      input.addEventListener('change', function() {
        if (this.value === 'bank_transfer') {
          bankDetailsSection.style.display = 'block';
          // Make bank fields required
          bankFields.forEach(field => {
            field.setAttribute('required', 'required');
          });
        } else {
          bankDetailsSection.style.display = 'none';
          // Make bank fields not required
          bankFields.forEach(field => {
            field.removeAttribute('required');
          });
        }
      });
    });
    
    // Handle form submission
    const tradeInForm = document.getElementById('trade-in-form');
    if (tradeInForm) {
      tradeInForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check if bank transfer is selected
        const isBankTransfer = document.getElementById('payment-cash').checked;
        
        // Validate bank fields if bank transfer is selected
        if (isBankTransfer) {
          let bankFieldsValid = true;
          
          bankFields.forEach(field => {
            if (!field.value.trim()) {
              bankFieldsValid = false;
              field.classList.add('error');
            } else {
              field.classList.remove('error');
            }
          });
          
          if (!bankFieldsValid) {
            alert('Please fill in all bank details for cash trade-in.');
            return;
          }
        }
        
        // In a real implementation, you would:
        // 1. Validate all form fields
        // 2. Submit the form data to your backend/app
        // 3. Process the trade-in order
        // 4. Clear the cart or mark items as being processed
        
        // For this example, we'll just show a success message
        alert('Thank you! Your trade-in request has been submitted successfully. You will receive instructions on how to ship your items shortly.');
        
        // Redirect to a confirmation page
        window.location.href = '/pages/trade-in-confirmation';
      });
    }
  });
</script>

<style>
  .trade-in-checkout-page {
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
  }
  
  .checkout-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    margin-top: 20px;
  }
  
  /* Summary section */
  .trade-in-summary-section {
    flex: 1;
    min-width: 300px;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 4px;
  }
  
  .summary-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
  }
  
  .summary-item-image img {
    width: 50px;
    height: 50px;
    object-fit: contain;
  }
  
  .summary-item-details {
    flex: 1;
    padding: 0 15px;
  }
  
  .summary-item-title {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .summary-item-meta {
    font-size: 0.9em;
    color: #666;
  }
  
  .summary-item-value {
    font-weight: bold;
  }
  
  .trade-in-total-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #ddd;
  }
  
  .trade-in-total-row {
    display: flex;
    justify-content: space-between;
    font-size: 1.2em;
    font-weight: bold;
  }
  
  .total-value {
    color: #0056b3;
  }
  
  /* Form section */
  .trade-in-shipping-section {
    flex: 2;
    min-width: 400px;
  }
  
  .trade-in-form {
    margin-top: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
  }
  
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  .radio-group {
    margin-bottom: 10px;
  }
  
  .radio-group label {
    display: inline;
    font-weight: normal;
    margin-left: 8px;
  }
  
  .form-actions {
    margin-top: 30px;
  }
  
  .form-actions .btn {
    padding: 12px 24px;
  }
  
  /* Error styling */
  .error {
    border: 1px solid #ff0000 !important;
    background-color: #ffeeee;
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    .checkout-container {
      flex-direction: column;
    }
    
    .trade-in-shipping-section,
    .trade-in-summary-section {
      min-width: 100%;
    }
  }
</style>